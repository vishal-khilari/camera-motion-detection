<!doctype html>
<html lang="en">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>MotionCam ‚Äî Capture & Detect</title>
    <style>
        :root {
            --bg: #0f1724;
            --card: #0b1220;
            --accent: #1fb6ff;
            --accent-2: #7c3aed;
            --glass: rgba(255, 255, 255, 0.05);
            --muted: rgba(255, 255, 255, 0.65);
            color-scheme: dark;
        }

        * {
            box-sizing: border-box
        }

        body {
            margin: 0;
            font-family: Inter, ui-sans-serif, system-ui, Arial;
            background: linear-gradient(180deg, #071025 0%, var(--bg) 100%);
            color: #e6eef8;
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 28px
        }

        .app {
            width: 100%;
            max-width: 980px;
            border-radius: 14px;
            background: linear-gradient(180deg, rgba(255, 255, 255, 0.02), rgba(255, 255, 255, 0.01));
            box-shadow: 0 10px 30px rgba(2, 6, 23, 0.7);
            overflow: hidden;
            display: grid;
            grid-template-columns: 1fr 360px;
            gap: 20px;
            padding: 20px;
        }

        header {
            grid-column: 1/-1;
            display: flex;
            align-items: center;
            gap: 14px
        }

        .logo {
            width: 54px;
            height: 54px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: linear-gradient(135deg, var(--accent), var(--accent-2));
            font-weight: 700;
            box-shadow: 0 6px 18px rgba(31, 182, 255, 0.12)
        }

        .title {
            font-size: 18px;
            font-weight: 700
        }

        .subtitle {
            font-size: 12px;
            color: var(--muted)
        }

        .viewer {
            background: linear-gradient(180deg, rgba(255, 255, 255, 0.02), rgba(255, 255, 255, 0.01));
            border-radius: 12px;
            padding: 12px;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 10px
        }

        video {
            width: 100%;
            height: 100%;
            max-height: 520px;
            border-radius: 8px;
            background: #000;
            object-fit: cover;
            display: block
        }

        .controls {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
            justify-content: center
        }

        .btn {
            background: var(--glass);
            border: 1px solid rgba(255, 255, 255, 0.04);
            padding: 10px 14px;
            border-radius: 10px;
            color: var(--muted);
            cursor: pointer;
            font-weight: 600
        }

        .btn.primary {
            background: linear-gradient(90deg, var(--accent), var(--accent-2));
            color: #061022
        }

        .right {
            display: flex;
            flex-direction: column;
            gap: 12px
        }

        .card {
            background: linear-gradient(180deg, rgba(255, 255, 255, 0.02), rgba(255, 255, 255, 0.01));
            border-radius: 12px;
            padding: 12px
        }

        .thumb {
            width: 100%;
            border-radius: 8px;
            height: 200px;
            object-fit: cover;
            background: linear-gradient(90deg, #061021, #07172a);
            display: block
        }

        label {
            font-size: 12px;
            color: var(--muted);
            display: block;
            margin-bottom: 6px
        }

        select,
        input[type="range"],
        input[type="text"] {
            width: 100%;
            padding: 8px;
            border-radius: 8px;
            border: 1px solid rgba(255, 255, 255, 0.04);
            background: var(--glass);
            color: inherit;
            font-family: inherit;
        }

        input[type="text"]:focus {
            border-color: var(--accent);
            outline: none;
            box-shadow: 0 0 0 2px rgba(31, 182, 255, 0.2);
        }

        .meta {
            font-size: 12px;
            color: var(--muted);
            display: flex;
            justify-content: space-between;
            gap: 8px
        }

        footer {
            grid-column: 1/-1;
            text-align: center;
            margin-top: 6px;
            color: var(--muted);
            font-size: 12px
        }

        @media(max-width:880px) {
            body {
                padding: 10px;
                align-items: flex-start;
            }

            .app {
                grid-template-columns: 1fr;
                gap: 15px;
                padding: 15px;
                max-width: 100%;
            }

            .viewer {
                order: 1;
            }

            .right {
                order: 2;
            }

            video {
                max-height: 60vh;
            }

            .controls {
                gap: 6px;
            }

            .btn {
                padding: 8px 12px;
                font-size: 14px;
                flex: 1;
                min-width: 0;
                text-align: center;
            }

            .controls .btn:nth-child(1),
            .controls .btn:nth-child(2),
            .controls .btn:nth-child(3) {
                flex-basis: calc(33.333% - 4px);
            }

            .controls .btn:nth-child(4),
            .controls .btn:nth-child(5) {
                flex-basis: calc(50% - 3px);
            }

            .controls .btn:nth-child(6),
            .controls .btn:nth-child(7),
            .controls .btn:nth-child(8) {
                flex-basis: calc(33.333% - 4px);
            }

            footer {
                display: none;
            }
        }
    </style>
</head>

<body>
    <main class="app" aria-labelledby="appTitle">
        <header>
            <div class="logo" aria-hidden>VK</div>
            <div>
                <div id="appTitle" class="title">MotionCam ‚Äî Capture & Detect</div>
                <div class="subtitle">Capture, preview, send, and detect motion</div>
            </div>
        </header>

        <section class="viewer card">
            <video id="video" playsinline autoplay></video>

            <div class="controls">
                <button class="btn" id="switch">üîÅ Switch</button>
                <button class="btn" id="countdown">‚è± 3s</button>
                <button class="btn primary" id="capture">üì∏ Capture</button>
                <button class="btn primary" id="captureSend">üì° Capture & Send</button>
                <button class="btn" id="retake">‚Ü∫ Retake</button>
                <button class="btn" id="download">‚¨áÔ∏è Download</button>
                <button class="btn primary" id="send">üì§ Send</button>
                <button class="btn primary" id="motion">üé• Toggle Motion</button>
            </div>

            <p id="status" class="meta">Status: <span id="statustxt">Initializing camera‚Ä¶</span></p>
        </section>

        <aside class="right">
            <div class="card">
                <label for="devices">Camera device</label>
                <select id="devices" aria-label="Choose camera"></select>
            </div>

            <div class="card">
                <label for="quality">Resolution</label>
                <select id="quality">
                    <option value="high">High (prefer max)</option>
                    <option value="medium">Medium (1280√ó720)</option>
                    <option value="low">Low (640√ó480)</option>
                </select>
            </div>

            <div class="card">
                <label>Preview</label>
                <img id="thumb" class="thumb" alt="captured preview" />
                <div style="margin-top:8px" class="meta">
                    <span id="capturedAt">‚Äî</span>
                    <span id="resolution">‚Äî</span>
                </div>
            </div>

            <div class="card">
                <label for="webhook">Webhook</label>
                <input id="webhook" type="text"
                    value="https://n8n-s73k.onrender.com/webhook/e41afa79-1104-406a-8e7d-aa8f78594d04" />
            </div>
        </aside>

        <footer>Keyboard: [C]apture ‚Ä¢ [S]end ‚Ä¢ [R]etake ‚Ä¢ [D]ownload ‚Ä¢ [X]Capture & Send ‚Ä¢ [T]oggle Motion</footer>
    </main>

    <canvas id="canvas" style="display:none"></canvas>

    <script>
        const video = document.getElementById('video');
        const devicesSelect = document.getElementById('devices');
        const qualitySelect = document.getElementById('quality');
        const captureBtn = document.getElementById('capture');
        const captureSendBtn = document.getElementById('captureSend');
        const switchBtn = document.getElementById('switch');
        const retakeBtn = document.getElementById('retake');
        const sendBtn = document.getElementById('send');
        const downloadBtn = document.getElementById('download');
        const countdownBtn = document.getElementById('countdown');
        const motionBtn = document.getElementById('motion');
        const statusText = document.getElementById('statustxt');
        const thumb = document.getElementById('thumb');
        const canvas = document.getElementById('canvas');
        const webhookInput = document.getElementById('webhook');
        const capturedAt = document.getElementById('capturedAt');
        const resolutionLabel = document.getElementById('resolution');

        let stream = null;
        let currentDeviceId = null;
        let capturedBlob = null;
        let availableDevices = [];

        function logStatus(txt) { statusText.innerText = txt }

        // device handling
        async function listDevices() {
            const devices = await navigator.mediaDevices.enumerateDevices();
            const cams = devices.filter(d => d.kind === 'videoinput');
            availableDevices = cams;

            devicesSelect.innerHTML = '';
            cams.forEach((c, i) => {
                const opt = document.createElement('option');
                opt.value = c.deviceId;
                opt.text = c.label || `Camera ${i + 1}`;
                devicesSelect.appendChild(opt);
            });

            // Set the first camera as default if no current device
            if (cams.length && !currentDeviceId) {
                currentDeviceId = cams[0].deviceId;
            }

            // Update the select to show the currently active device
            if (currentDeviceId) {
                devicesSelect.value = currentDeviceId;
            }
        }

        async function startStream(deviceId) {
            if (stream) {
                stream.getTracks().forEach(t => t.stop());
                stream = null;
            }

            const quality = qualitySelect.value;
            let constraints = { audio: false, video: {} };

            if (deviceId) {
                constraints.video.deviceId = { exact: deviceId };
            }

            if (quality === 'high') {
                constraints.video.width = { ideal: 1920 };
                constraints.video.height = { ideal: 1080 };
            }
            if (quality === 'medium') {
                constraints.video.width = { exact: 1280 };
                constraints.video.height = { exact: 720 };
            }
            if (quality === 'low') {
                constraints.video.width = { exact: 640 };
                constraints.video.height = { exact: 480 };
            }

            try {
                stream = await navigator.mediaDevices.getUserMedia(constraints);
                video.srcObject = stream;

                // Update currentDeviceId to match the actual device being used
                const track = stream.getVideoTracks()[0];
                const settings = track.getSettings();

                if (settings.deviceId) {
                    currentDeviceId = settings.deviceId;
                    // Update the dropdown to show the correct selection
                    devicesSelect.value = currentDeviceId;
                }

                resolutionLabel.innerText = `${settings.width} √ó ${settings.height}`;
                logStatus('Camera ready');

                // Refresh device list to get updated labels
                await listDevices();

            } catch (error) {
                logStatus('Camera error: ' + error.message);
                console.error('Camera error:', error);
            }
        }

        // capture
        function captureImage() {
            if (!stream) return logStatus('No camera stream');
            const vw = video.videoWidth; const vh = video.videoHeight;
            canvas.width = vw; canvas.height = vh;
            const ctx = canvas.getContext('2d');
            ctx.drawImage(video, 0, 0, vw, vh);
            canvas.toBlob(blob => {
                capturedBlob = blob;
                thumb.src = URL.createObjectURL(blob);
                capturedAt.innerText = new Date().toLocaleString();
                logStatus('Captured');
            }, 'image/png');
        }

        // send
        async function sendImage() {
            if (!capturedBlob) return logStatus('Capture first');
            const form = new FormData();
            form.append('file', capturedBlob, 'image.png');
            form.append('metadata', JSON.stringify({
                capturedAt: new Date().toISOString(),
                resolution: resolutionLabel.innerText,
                deviceId: currentDeviceId
            }));
            try {
                const res = await fetch(webhookInput.value, { method: 'POST', body: form });
                logStatus(res.ok ? 'Sent ‚úÖ' : 'Send failed ' + res.status);
            } catch (error) {
                logStatus('Send error: ' + error.message);
            }
        }

        async function captureThenSend() {
            captureImage();
            setTimeout(sendImage, 500);
        }

        function downloadImage() {
            if (!capturedBlob) return logStatus('Nothing to download');
            const a = document.createElement('a');
            a.href = URL.createObjectURL(capturedBlob);
            a.download = `motioncam-${Date.now()}.png`;
            a.click();
        }

        // motion detection
        let motionEnabled = false, lastFrame = null, motionCooldown = false;

        function detectMotion() {
            if (!motionEnabled || !stream) return;
            const vw = video.videoWidth, vh = video.videoHeight;
            if (!vw || !vh) return;
            const ctx = canvas.getContext('2d');
            canvas.width = vw; canvas.height = vh;
            ctx.drawImage(video, 0, 0, vw, vh);
            const frame = ctx.getImageData(0, 0, vw, vh);

            if (lastFrame) {
                let diff = 0;
                for (let i = 0; i < frame.data.length; i += 80) {
                    const d = Math.abs(frame.data[i] - lastFrame.data[i]) +
                        Math.abs(frame.data[i + 1] - lastFrame.data[i + 1]) +
                        Math.abs(frame.data[i + 2] - lastFrame.data[i + 2]);
                    if (d > 60) diff++;
                }
                if (diff > 2000 && !motionCooldown) {
                    logStatus(`Motion detected (${diff}) üö®`);
                    captureThenSend();
                    motionCooldown = true;
                    setTimeout(() => motionCooldown = false, 8000);
                }
            }
            lastFrame = frame;
            requestAnimationFrame(detectMotion);
        }

        function toggleMotion() {
            motionEnabled = !motionEnabled;
            logStatus(motionEnabled ? 'Motion ON üëÄ' : 'Motion OFF ‚õî');
            if (motionEnabled) {
                lastFrame = null;
                detectMotion();
            }
        }

        // events
        captureBtn.onclick = captureImage;
        captureSendBtn.onclick = captureThenSend;
        downloadBtn.onclick = downloadImage;
        sendBtn.onclick = sendImage;
        retakeBtn.onclick = () => {
            capturedBlob = null;
            thumb.src = '';
            capturedAt.innerText = '‚Äî';
            logStatus('Ready');
        };

        // Fixed device selection event handler
        devicesSelect.onchange = e => {
            const selectedDeviceId = e.target.value;
            currentDeviceId = selectedDeviceId;
            startStream(currentDeviceId);
        };

        qualitySelect.onchange = () => startStream(currentDeviceId);

        // Fixed switch button logic
        switchBtn.onclick = () => {
            const opts = [...devicesSelect.options];
            if (opts.length <= 1) return logStatus('Only one camera available');

            const currentIndex = opts.findIndex(o => o.value === currentDeviceId);
            const nextIndex = (currentIndex + 1) % opts.length;
            const nextDeviceId = opts[nextIndex].value;

            currentDeviceId = nextDeviceId;
            devicesSelect.value = currentDeviceId;
            startStream(currentDeviceId);
        };

        countdownBtn.onclick = () => {
            let i = 3;
            countdownBtn.disabled = true;
            const t = setInterval(() => {
                if (--i > 0) logStatus('Countdown ' + i);
                else {
                    clearInterval(t);
                    captureImage();
                    countdownBtn.disabled = false;
                }
            }, 1000);
        };

        motionBtn.onclick = toggleMotion;

        window.onkeydown = e => {
            if (e.key === 'c' || e.key === 'C') captureImage();
            if (e.key === 's' || e.key === 'S') sendImage();
            if (e.key === 'x' || e.key === 'X') captureThenSend();
            if (e.key === 'r' || e.key === 'R') {
                capturedBlob = null;
                thumb.src = '';
                capturedAt.innerText = '‚Äî';
                logStatus('Ready');
            }
            if (e.key === 'd' || e.key === 'D') downloadImage();
            if (e.key === 't' || e.key === 'T') toggleMotion();
        };

        // Initialize the application
        (async () => {
            try {
                await listDevices();
                await startStream(currentDeviceId);
            } catch (error) {
                logStatus('Initialization error: ' + error.message);
                console.error('Initialization error:', error);
            }
        })();
    </script>
</body>

</html>